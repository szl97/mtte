# mtte

#### 介绍
工作中需要多线程拆解处理任务，写的两个工具类
1、提供一个支持多线程的事务控制工具
2、提供一个使用多线程分解一次大批量查询任务的工具

#### 支持多线程的事务控制工具

当进行大批量操作时，同步去执行肯定效率低，我们会想到用多线程去拆解任务。
但是多线程的时候，如果是增删改的批量操作，除了无法保证顺序，也无法失败时同时回滚。

因此开发了一个适用于多线程的事务控制器，来处理没有顺序要求，但是需要回滚的大批量处理数据的场景。

开发思路：
1、以insert为例子，核心思路是，创建事务，每个线程开启事务，执行insert成功后，释放锁，失败除了释放锁，还要保存一下失败结果，等待所有线程都释放锁了，判断失败结果来决定执行commit还是rollback

2、在性能和稳定性方面的处理：
1）执行器中有主线程池和工作线程池。当有任务加入时，主线程会根据此任务需要的工作线程来决定先执行谁。分为公平和非公平两种模式。公平模式下，对于先加入的任务，如果线程数不够，会等待，直到线程数足够再执行。而非公平模式下，会将当前无法执行的任务直接扔到队列末尾，去看下一个任务。也就是说，它在执行任务较多，工作线程不够的情况下，会优先去执行更容易执行的任务。
2）一个主任务执行的时候，并行的线程数为2*CPU，因为都是I/O 操作的场景下使用
3）提供了一个可以在工作线程执行任务的时候，更灵活得去“安排”线程的方法。就是工作线程执行时的CyclicBarried参数，这是考虑到执行一个任务的过程中，可能中间还分了很多步，可能要所有线程执行完第一步，再所有线程去执行第二步操作，这个时候就可以用到了
4）目前工作线程设置为20个，每个线程都开启一个新事务，且过程中存在加锁等待，由于开启数据库事务的时候，也是对数据库连接进行加锁，如果数据库连接不够这些工作线程分，那么就会产生死锁。因此要注意数据库连接池与工作线程数的配置。目前数据库最大连接设置为200，工作线程设置为20，目前数据库连接很充足。如果数据库连接很紧张的业务场景下，可以考虑给该处理器单独配置连接池，防止这里加锁等待对其他业务的干扰。这可以做后续功能的扩展
5）主线程池为3，就是说最多3个任务去瓜分这20个线程

#### testplan
![32W条数据插入debug日志](image.png)

用在线标注为例进行测试，之所以做这个是因为我生产上点了几下感觉生成很慢，测试环境加了好几条跨度很大的查询后，卡住了。

目前在本地，模拟数据，只测试插入结果如下：
![输入图片说明](image.png)

刚开始数据生成时间加执行器处理时间为20+s（前四条）
后来优化了一下，执行器主要是改参数，主要时间是批量生成数据时，一开始用的join()阻塞时间有点长，后来改为自己加锁控制，生成—+处理只需要1S，可以看到这个执行器是非常快的。
最后五组数据是同时点了5下，模拟一个任务还没结束的时候，其他任务也加入，且都要占据所有工作线程的并发场景，可以看到能够完美满足

考虑到生产环境下，生成数据耗时可能更长一些
![测试参数](image.png)

使用这个参数进行测试，生成数据的线程每条只处理5天，这大概时间跨度是3年，也就是说生成数据时分成了500多个任务，每个任务都sleep 3s，应该可以模拟出生产环境一次请求非常多的场景了。


整个任务的耗时为2min，这个算是模拟比较极端的场景了
![输入图片说明](image.png)



#### 多线程分解一次大批量查询任务的工具
![测试结果](image.png)

调用举例：本例用map储存了查询结果，所以返回null。


可以配合 MultiThredTransactionExcutor用于同步数据